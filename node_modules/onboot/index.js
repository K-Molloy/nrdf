var outstanding = 0;
var bootup = function () {};
var bootable = false;

function checkOutstanding() {
  if (outstanding === 0 && bootable) {
    bootup();
  }
}

function bootstrap(callback) {
  outstanding++;
  if (callback.length) {
    // expects "done"
    var callable = true;
    var done = function () {
      if (callable) {
        outstanding--;
        callable = false;
        checkOutstanding();
        return;
      }

      throw new Error('done called multiple times');
    };

    callback.call(this, done);
  } else {
    callback.call(this);
    outstanding--;
  }
}

function boot(callback) {
  bootable = true;
  bootup = callback.bind(this);
  checkOutstanding();
}

module.exports = {
  up: boot,
  strap: bootstrap,
};